name: Create Release Bundle

on:
  workflow_call:
    inputs:
      jfrog_project:
        required: true
        type: string
      version:
        required: true
        type: string
      image:
        required: true
        type: string
      digest:
        required: true
        type: string
    secrets:
      JF_URL:
        required: true
      JF_ACCESS_TOKEN:
        required: true

jobs:
  create-release-bundle:
    name: Create Release Bundle v2
    runs-on: ubuntu-latest

    env:
      JFROG_PROJECT: ${{ inputs.jfrog_project }}
      RB_NAME: spring-petclinic-cloud
      RB_VERSION: ${{ inputs.version }}
      IMAGE: ${{ inputs.image }}
      DIGEST: ${{ inputs.digest }}

    steps:

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Display artifact info
        run: |
          echo "Release Bundle: $RB_NAME"
          echo "Version:       $RB_VERSION"
          echo "Image:         $IMAGE"
          echo "Digest:        $DIGEST"
          echo "Project:       $JFROG_PROJECT"

      - name: Create Release Bundle v2
        run: |
          jf release-bundle-create "$RB_NAME" "$RB_VERSION" \
            --signing-key=default \
            --project="$JFROG_PROJECT" \
            --spec=- <<EOF
          {
            "files": [
              {
                "pattern": "${IMAGE}@${DIGEST}",
                "target": "release-bundles/"
              }
            ]
          }
          EOF

      - name: Distribute Release Bundle (optional)
        if: ${{ vars.DISTRIBUTION_ENABLED == 'true' }}
        run: |
          jf release-bundle-distribute "$RB_NAME" "$RB_VERSION" \
            --site="default" \
            --project="$JFROG_PROJECT"

          echo "Release Bundle distributed."