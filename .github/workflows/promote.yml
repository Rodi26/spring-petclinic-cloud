name: Promote

on:
  workflow_run:
    workflows: ["Java_CI_with_Maven"]
    types:
      - completed
    branches: [ master ]
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number from Java_CI_with_Maven workflow to promote'
        required: false
        type: string
        default: 'latest'
      version:
        description: 'Version to promote (e.g., 2.6.3.285) - leave empty to auto-detect'
        required: false
        type: string
      release_bundle_name:
        description: 'Release bundle name'
        required: false
        type: string
        default: 'spring-petclinic-cloud-promoted'
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options:
          - production-ready
          - staging
          - qa
        default: 'production-ready'
  push:
    branches: [ master ]
    paths: [ '.github/workflows/promote.yml' ]
  schedule:
    # Allow scheduled promotions of latest successful build
    - cron: "0 2 * * *"
permissions:
  actions: read           # for  detecting the Github Actions environment
  id-token: write         # for creating OIDC tokens for signing
  packages: write         # for uploading attestations
  contents: read          # read the contents permission
  security-events: write  # for uploading code scanning


jobs:
  promote:
    name: Promote Release Bundle
    runs-on: ubuntu-latest
    # Run if workflow_run was successful, or for any other trigger type
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    steps:
      - name: Check workflow trigger and determine execution mode
        run: |
          case "${{ github.event_name }}" in
            "workflow_run")
              echo "ðŸš€ Triggered by successful Java_CI_with_Maven workflow"
              echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
              echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
              echo "Build number: ${{ github.event.workflow_run.run_number }}"
              echo "EXECUTION_MODE=automatic" >> $GITHUB_ENV
              ;;
            "workflow_dispatch")
              echo "ðŸš€ Manually triggered promotion"
              echo "Build number: ${{ github.event.inputs.build_number || 'latest' }}"
              echo "Version: ${{ github.event.inputs.version || 'auto-detect' }}"
              echo "Environment: ${{ github.event.inputs.environment || 'production-ready' }}"
              echo "Release bundle: ${{ github.event.inputs.release_bundle_name || 'spring-petclinic-cloud-promoted' }}"
              echo "EXECUTION_MODE=manual" >> $GITHUB_ENV
              ;;
            "push")
              echo "ðŸš€ Triggered by workflow file update - promoting latest build"
              echo "EXECUTION_MODE=push_trigger" >> $GITHUB_ENV
              ;;
            "schedule")
              echo "ðŸš€ Scheduled promotion of latest successful build"
              echo "EXECUTION_MODE=scheduled" >> $GITHUB_ENV
              ;;
            *)
              echo "ðŸš€ Independent promotion execution"
              echo "EXECUTION_MODE=independent" >> $GITHUB_ENV
              ;;
          esac
      - name: checkout Git repository
        uses: actions/checkout@v4
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: 'adopt'
          cache: maven
      
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      
      - name: Set promotion variables
        run: |
          # Get base version from POM
          BASE_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/-SNAPSHOT//')
          ARTIFACT_NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          
          case "$EXECUTION_MODE" in
            "automatic")
              # Use version from triggering workflow
              BUILD_NUMBER="${{ github.event.workflow_run.run_number }}"
              PROMOTION_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
              ;;
            "manual")
              # Use provided values or auto-detect
              if [[ -n "${{ github.event.inputs.version }}" ]]; then
                PROMOTION_VERSION="${{ github.event.inputs.version }}"
                BUILD_NUMBER=$(echo "$PROMOTION_VERSION" | cut -d'.' -f4)
              elif [[ "${{ github.event.inputs.build_number }}" != "latest" ]]; then
                BUILD_NUMBER="${{ github.event.inputs.build_number }}"
                PROMOTION_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
              else
                # Find latest successful build
                echo "ðŸ” Finding latest successful build..."
                LATEST_BUILD=$(jf rt search "dev-oci-local/spring-petclinic-cloud-api-gateway/*/manifest.json" \
                  --sort-by=created --sort-order=desc --limit=1 --format=json | \
                  jq -r '.[0].path' | sed 's|.*/\([0-9.]*\)/.*|\1|' || echo "")
                if [[ -n "$LATEST_BUILD" ]]; then
                  PROMOTION_VERSION="$LATEST_BUILD"
                  BUILD_NUMBER=$(echo "$PROMOTION_VERSION" | cut -d'.' -f4)
                else
                  echo "âŒ Could not find latest build"
                  exit 1
                fi
              fi
              ;;
            "scheduled"|"push_trigger"|"independent")
              # Find latest successful build for independent execution
              echo "ðŸ” Finding latest successful build for independent promotion..."
              LATEST_BUILD=$(jf rt search "dev-oci-local/spring-petclinic-cloud-api-gateway/*/manifest.json" \
                --sort-by=created --sort-order=desc --limit=1 --format=json | \
                jq -r '.[0].path' | sed 's|.*/\([0-9.]*\)/.*|\1|' || echo "")
              if [[ -n "$LATEST_BUILD" ]]; then
                PROMOTION_VERSION="$LATEST_BUILD"
                BUILD_NUMBER=$(echo "$PROMOTION_VERSION" | cut -d'.' -f4)
              else
                echo "âŒ Could not find latest build for promotion"
                exit 1
              fi
              ;;
          esac
          
          # Set environment variables
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          echo "PROMOTION_VERSION=${PROMOTION_VERSION}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          echo "RELEASE_BUNDLE_NAME=${{ github.event.inputs.release_bundle_name || 'spring-petclinic-cloud-promoted' }}" >> $GITHUB_ENV
          echo "TARGET_ENVIRONMENT=${{ github.event.inputs.environment || 'production-ready' }}" >> $GITHUB_ENV
          
          echo "ðŸ·ï¸  Promotion Details:"
          echo "  - Execution Mode: ${EXECUTION_MODE}"
          echo "  - Build Number: ${BUILD_NUMBER}"
          echo "  - Version: ${PROMOTION_VERSION}"
          echo "  - Artifact: ${ARTIFACT_NAME}"
          echo "  - Release Bundle: ${{ github.event.inputs.release_bundle_name || 'spring-petclinic-cloud-promoted' }}"
          echo "  - Environment: ${{ github.event.inputs.environment || 'production-ready' }}"
      
      - name: Verify artifacts exist before promotion
        run: |
          echo "ðŸ” Verifying artifacts exist for promotion..."
          
          # Check if Docker containers exist for this version
          for service in spring-petclinic-cloud-api-gateway spring-petclinic-cloud-visits-service spring-petclinic-cloud-vets-service spring-petclinic-cloud-customers-service spring-petclinic-cloud-admin-server spring-petclinic-cloud-discovery-service spring-petclinic-cloud-config-server; do
            echo "Checking ${service}:${PROMOTION_VERSION}..."
            if jf rt search "dev-oci-local/${service}/${PROMOTION_VERSION}/*" --format=json | jq -e 'length > 0' >/dev/null; then
              echo "âœ… ${service}:${PROMOTION_VERSION} found"
            else
              echo "âŒ ${service}:${PROMOTION_VERSION} not found"
              exit 1
            fi
          done
          
          echo "âœ… All artifacts verified for promotion"
      
      - name: Create Release Bundle for RLM
        run: |
          echo "ðŸ“¦ Creating release bundle for version ${PROMOTION_VERSION}..."
          
          # Create file spec for the release bundle
          cat > promotion-release-bundle-spec.json << EOF
          {
            "files": [
              {
                "pattern": "dev-oci-local/spring-petclinic-cloud-*/${PROMOTION_VERSION}/*"
              }
            ]
          }
          EOF
          
          # Create release bundle with proper version
          jf rbc --spec promotion-release-bundle-spec.json \
            --signing-key=${{ secrets.Key }} \
            ${RELEASE_BUNDLE_NAME} \
            ${PROMOTION_VERSION} \
            --sync=true
          
          echo "âœ… Release bundle created: ${RELEASE_BUNDLE_NAME}:${PROMOTION_VERSION}"
      
      - name: Create promotion evidence
        run: |
          echo "ðŸ“‹ Creating promotion evidence..."
          
          cat > promotion_evidence.json << EOF
          {
            "promotion": {
              "version": "v1",
              "promoted_version": "${PROMOTION_VERSION}",
              "build_number": "${BUILD_NUMBER}",
              "promoted_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "promoted_by": "${{ github.actor }}",
              "execution_mode": "${EXECUTION_MODE}",
              "source_workflow": {
                "name": "Java_CI_with_Maven",
                "run_id": "${{ github.event.workflow_run.id || 'independent' }}",
                "conclusion": "${{ github.event.workflow_run.conclusion || 'independent' }}"
              },
              "promoted_artifacts": [
                "spring-petclinic-cloud-api-gateway:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-visits-service:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-vets-service:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-customers-service:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-admin-server:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-discovery-service:${PROMOTION_VERSION}",
                "spring-petclinic-cloud-config-server:${PROMOTION_VERSION}"
              ],
              "release_bundle": "${RELEASE_BUNDLE_NAME}:${PROMOTION_VERSION}",
              "environment": "${TARGET_ENVIRONMENT}"
            }
          }
          EOF
          
          cat > promotion-results.md << EOF
          # Promotion Evidence
          
          ## Promotion Summary
          - **Version**: ${PROMOTION_VERSION}
          - **Build Number**: ${BUILD_NUMBER}
          - **Promoted At**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Promoted By**: ${{ github.actor }}
          - **Environment**: ${TARGET_ENVIRONMENT}
          - **Execution Mode**: ${EXECUTION_MODE}
          
          ## Source Build
          - **Workflow**: Java_CI_with_Maven
          - **Run ID**: ${{ github.event.workflow_run.id || 'independent' }}
          - **Conclusion**: ${{ github.event.workflow_run.conclusion || 'independent' }}
          
          ## Promoted Artifacts
          - âœ… spring-petclinic-cloud-api-gateway:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-visits-service:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-vets-service:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-customers-service:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-admin-server:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-discovery-service:${PROMOTION_VERSION}
          - âœ… spring-petclinic-cloud-config-server:${PROMOTION_VERSION}
          
          ## Release Bundle
          - **Name**: ${RELEASE_BUNDLE_NAME}
          - **Version**: ${PROMOTION_VERSION}
          - **Status**: âœ… Created and Signed
          
          ## Next Steps
          - The release bundle is now ready for distribution to the `${TARGET_ENVIRONMENT}` environment.
          EOF
          
          # Create promotion evidence for the release bundle
          echo "Creating promotion evidence for release bundle ${RELEASE_BUNDLE_NAME}:${PROMOTION_VERSION}..."
          jf evd create --predicate=promotion_evidence.json --predicate-type=https://jfrog.com/evidence/promotion/v1 \
            --rb-name=${RELEASE_BUNDLE_NAME} --rb-version=${PROMOTION_VERSION} \
            --markdown promotion-results.md --project=${{ vars.JFROG_PROJECT }}
          
          echo "âœ… Promotion completed successfully!"
          echo "ðŸš€ Release bundle ${RELEASE_BUNDLE_NAME}:${PROMOTION_VERSION} is ready for deployment"
          echo "ðŸ“Š Execution mode: ${EXECUTION_MODE}"
          echo "ðŸŽ¯ Target environment: ${TARGET_ENVIRONMENT}"