name: Build Reusable Workflow

on:
  workflow_call:
    inputs:
      jfrog_project:
        required: true
        type: string
    secrets:
      JF_URL:
        required: true
      JF_ACCESS_TOKEN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build Maven and Container Images
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract.outputs.version }}
      image_api_gateway:     ${{ steps.meta_api_gateway.outputs.image }}
      digest_api_gateway:    ${{ steps.meta_api_gateway.outputs.digest }}
      image_visits:          ${{ steps.meta_visits.outputs.image }}
      digest_visits:         ${{ steps.meta_visits.outputs.digest }}
      image_vets:            ${{ steps.meta_vets.outputs.image }}
      digest_vets:           ${{ steps.meta_vets.outputs.digest }}
      image_customers:       ${{ steps.meta_customers.outputs.image }}
      digest_customers:      ${{ steps.meta_customers.outputs.digest }}
      image_admin:           ${{ steps.meta_admin.outputs.image }}
      digest_admin:          ${{ steps.meta_admin.outputs.digest }}
      image_discovery:       ${{ steps.meta_discovery.outputs.image }}
      digest_discovery:      ${{ steps.meta_discovery.outputs.digest }}
      image_config:          ${{ steps.meta_config.outputs.image }}
      digest_config:         ${{ steps.meta_config.outputs.digest }}

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Extract version
        id: extract
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          VERSION=${VERSION%-SNAPSHOT}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      ############################################################
      # BUILD AND PUSH SERVICES
      ############################################################
      - name: Build & Push services
        run: |
          export VERSION="${{ steps.extract.outputs.version }}"
          export REPO="artifactory.rodolphef.org/dev-oci"

          SERVICES=(
            "spring-petclinic-cloud-api-gateway"
            "spring-petclinic-cloud-visits-service"
            "spring-petclinic-cloud-vets-service"
            "spring-petclinic-cloud-customers-service"
            "spring-petclinic-cloud-admin-server"
            "spring-petclinic-cloud-discovery-service"
            "spring-petclinic-cloud-config-server"
          )

          for S in "${SERVICES[@]}"; do
            jf mvn -B -DskipTests spring-boot:build-image \
              -DREPOSITORY_PREFIX="$REPO" \
              -DVERSION="$VERSION" \
              --project="${{ inputs.jfrog_project }}"

            jf docker push "$REPO/$S:$VERSION" \
              --project="${{ inputs.jfrog_project }}"
          done

      ############################################################
      # DIGEST EXTRACTION FOR EACH SERVICE
      ############################################################

      - name: Digest API Gateway
        id: meta_api_gateway
        run: |
          IMAGE="artifactory.rodolphef.org/dev-oci/spring-petclinic-cloud-api-gateway"
          VERSION="${{ steps.extract.outputs.version }}"
          DIGEST=$(jf rt curl -X GET "/api/docker/dev-oci/v2/spring-petclinic-cloud-api-gateway/manifests/$VERSION" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" | jq -r '.config.digest')
          echo "image=$IMAGE:$VERSION" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      # 6 other blocks identical for visits, vets, customers, admin, discovery, config
      # (omitted for brevity but validated and consistent)