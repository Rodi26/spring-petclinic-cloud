name: Maven Build Pipeline

on:
  workflow_call:
    inputs:
      jfrog_project:
        required: true
        type: string
      docker_repo_prefix:
        required: false
        type: string
        description: "Docker/OCI registry prefix (e.g. artifactory.rodolphef.org/dev-oci)"
      docker_repo_key:
        required: false
        type: string
        description: "Artifactory Docker repo key for API calls (e.g. dev-oci-local)"
    outputs:
      version:
        description: "Container version"
        value: ${{ jobs.build.outputs.version }}
      image:
        description: "Container image"
        value: ${{ jobs.build.outputs.image }}
      digest:
        description: "Container digest"
        value: ${{ jobs.build.outputs.digest }}
    secrets:
      JF_URL:
        required: true
      JF_ACCESS_TOKEN:
        required: true

permissions:
  contents: read
  id-token: write
  packages: write
  actions: read
  attestations: write

jobs:
  build:
    runs-on: ubuntu-latest

    # Spring Boot 2.6 build-image uses Docker API v1.24; host Docker 29+ requires 1.44+.
    # Use Docker 28 dind so the plugin can pull builder images (see spring-projects/spring-boot#48050).
    services:
      dind:
        image: docker:28-dind
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
        ports:
          - 2375:2375

    outputs:
      version: ${{ steps.set-version.outputs.containerversion }}
      image:   ${{ steps.metadata.outputs.image }}
      digest:  ${{ steps.metadata.outputs.digest }}

    env:
      REPO_PREFIX: ${{ inputs.docker_repo_prefix || vars.DOCKER_REPO_PREFIX || 'artifactory.rodolphef.org/dev-oci' }}
      DOCKER_REPO_KEY: ${{ inputs.docker_repo_key || vars.DOCKER_REPO_KEY || 'dev-oci-local' }}
      JFROG_PROJECT: ${{ inputs.jfrog_project }}
      DOCKER_HOST: tcp://localhost:2375

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: maven

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Extract version
        id: version
        run: |
          RAW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          BASE_VERSION="${RAW_VERSION%-SNAPSHOT}"
          CONTAINER_VERSION="${BASE_VERSION}.${GITHUB_RUN_NUMBER}"

          echo "container_version=${CONTAINER_VERSION}" >> $GITHUB_OUTPUT
          echo "CONTAINER_VERSION=${CONTAINER_VERSION}" >> $GITHUB_ENV
      - name: Set version output
        id: set-version
        run: echo "containerversion=${{ env.CONTAINER_VERSION }}" >> $GITHUB_OUTPUT

      - name: Configure Maven repos
        run: |
          jf mvnc \
            --repo-deploy-releases=${{ vars.MVN_DEV_REPO_DEPLOY_RELEASES || 'dev-maven' }} \
            --repo-deploy-snapshots=${{ vars.MVN_DEV_REPO_DEPLOY_SNAPSHOTS || 'dev-maven' }} \
            --repo-resolve-releases=${{ vars.MVN_DEV_REPO_RESOLVE_RELEASES || 'dev-maven' }} \
            --repo-resolve-snapshots=${{ vars.MVN_DEV_REPO_RESOLVE_SNAPSHOTS || 'dev-maven' }}

      - name: Force Maven to use Artifactory for ALL downloads (mirror)
        shell: bash
        run: |
          cat > ~/.m2/settings.xml <<'EOF'
          <settings>
            <servers>
              <server>
                <id>artifactory-remote</id>
                <username>${env.ARTIFACTORY_USERNAME}</username>
                <password>${env.ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>artifactory-docker</id>
                <username>${env.ARTIFACTORY_USERNAME}</username>
                <password>${env.ARTIFACTORY_PASSWORD}</password>
              </server>
            </servers>




            <mirrors>
              <mirror>
                <id>artifactory-remote</id>
                <name>Artifactory mirror</name>
                <url>https://artifactory.rodolphef.org/artifactory/spring-petclinic-maven-remote</url>
                <mirrorOf>*</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          EOF

      - name: Wait for Docker (dind)
        run: |
          for i in $(seq 1 30); do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker..."
            sleep 2
          done
          echo "Docker did not become ready"
          exit 1

      - name: Build images
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
        run: |
          # Image names (for push) and Maven module artifactIds (for -pl)
          SERVICES=( "spring-petclinic-cloud-api-gateway" "spring-petclinic-cloud-visits-service" "spring-petclinic-cloud-vets-service" "spring-petclinic-cloud-customers-service" "spring-petclinic-cloud-admin-server" "spring-petclinic-cloud-discovery-service" "spring-petclinic-cloud-config-server" )
          MODULES=( "spring-petclinic-api-gateway" "spring-petclinic-visits-service" "spring-petclinic-vets-service" "spring-petclinic-customers-service" "spring-petclinic-admin-server" "spring-petclinic-discovery-server" "spring-petclinic-config-server" )

          for i in "${!SERVICES[@]}"; do
            S="${SERVICES[$i]}"
            M="${MODULES[$i]}"
            mvn -B -DskipTests spring-boot:build-image -Pk8s \
              -pl ":${M}" -am \
              -DREPOSITORY_PREFIX=${REPO_PREFIX} \
              -DVERSION=${CONTAINER_VERSION}
          done

      - name: Push images
        run: |
          SERVICES=(
            "spring-petclinic-cloud-api-gateway"
            "spring-petclinic-cloud-visits-service"
            "spring-petclinic-cloud-vets-service"
            "spring-petclinic-cloud-customers-service"
            "spring-petclinic-cloud-admin-server"
            "spring-petclinic-cloud-discovery-service"
            "spring-petclinic-cloud-config-server"
          )

          for S in "${SERVICES[@]}"; do
            jf docker push ${REPO_PREFIX}/${S}:${CONTAINER_VERSION} \
              --project="${JFROG_PROJECT}"
          done

      - name: Extract image metadata all
        id: metadata
        run: |
          IMAGE="${REPO_PREFIX}/spring-petclinic-cloud-api-gateway:${CONTAINER_VERSION}"

          DIGEST=$(jf rt curl -X GET \
            "/api/docker/${DOCKER_REPO_KEY}/v2/spring-petclinic-cloud-api-gateway/manifests/${CONTAINER_VERSION}" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            | jq -r '.config.digest')

          echo "image=${IMAGE}"   >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Publish Build Info
        run: |
          jf rt bce --project="${JFROG_PROJECT}"
          jf rt bag --project="${JFROG_PROJECT}"
          jf rt bp  --project="${JFROG_PROJECT}"