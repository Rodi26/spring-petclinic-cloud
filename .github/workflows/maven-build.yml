name: Java CI with Maven (Modular Orchestrator )

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "0 0 * * *"

permissions:
  actions: read
  id-token: write
  contents: read
  packages: write
  security-events: write

jobs:

  build:
    name: Build
    uses: ./.github/workflows/build-reusable.yml
    with:
      jfrog_project: ${{ vars.JFROG_PROJECT }}
    secrets: inherit

  slsa-container-provenance:
    name: SLSA Container Provenance
    needs: build
    uses: ./.github/workflows/slsa-container-provenance.yml
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.digest }}
      registry_username: "admin"
    secrets:
      ORAS_TOKEN: ${{ secrets.ORAS_TOKEN }}

  rlm-evidence:
    name: RLM Evidence Integration
    needs: [build, slsa-container-provenance]
    uses: ./.github/workflows/rlm-evidence.yml
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.digest }}
      container_version: ${{ needs.build.outputs.container_version }}
      slsa_success: ${{ needs.slsa-container-provenance.result == 'success' }}
    secrets: inherit

  xray:
    name: Xray Scan Results
    needs: [build, rlm-evidence]
    if: always() && needs.build.result == 'success'
    uses: ./.github/workflows/xray-scan.yml
    with:
      container_version: ${{ needs.build.outputs.container_version }}
    secrets: inherit

  release_bundle:
    name: Release Bundle for RLM
    needs: [build, xray]
    if: always() && needs.build.result == 'success'
    uses: ./.github/workflows/release-bundle.yml
    with:
      container_version: ${{ needs.build.outputs.container_version }}
    secrets: inherit