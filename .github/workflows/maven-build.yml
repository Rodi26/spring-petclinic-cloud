name: Java_CI_with_Maven

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # The repository will be build once a day at 00:00 GMT.
    - cron: "0 0 * * *"

permissions:
  actions: read # for detecting the Github Actions environment
  id-token: write # for creating OIDC tokens for signing
  packages: write # for uploading attestations
  contents: read # read the contents permission
  security-events: write # for uploading code scanning

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    env:
      REPOSITORY_PREFIX: "artifactory.rodolphef.org/dev-oci"
      DOCKER_REPO: "dev-oci-local"
      IMAGE_NAME: "spring-petclinic-cloud"
    outputs:
      image: artifactory.rodolphef.org/${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_VERSION }}
      digest: ${{ steps.docker-push.outputs.digest }}
      container_version: ${{ env.CONTAINER_VERSION }}
    steps:
      - name: checkout Git repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{matrix.java}}
        uses: actions/setup-java@v4
        with:
          java-version: ${{matrix.java}}
          distribution: 'adopt'
          cache: maven

      - name: Extracting the artifact name and version from POM file
        run: |
          echo "ArtifactName=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)" >> $GITHUB_ENV
          echo "Version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_ENV

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Config JFrog CLI
        run: |
          jf mvnc --repo-deploy-releases=${{ vars.MVN_DEV_REPO_DEPLOY_RELEASES }} --repo-deploy-snapshots=${{ vars.MVN_DEV_REPO_DEPLOY_SNAPSHOTS }} --repo-resolve-releases=${{ vars.MVN_DEV_REPO_RESOLVE_RELEASES }} --repo-resolve-snapshots=${{ vars.MVN_DEV_REPO_RESOLVE_SNAPSHOTS }}

      - name: Validate Artifactory Dependencies
        run: |
          jf mvn validate
          echo "Checking for corrupted artifacts in repository..."
          SEARCH_RESULT=$(jf rt search "${{ vars.MVN_DEV_REPO_DEPLOY_RELEASES }}/*.pom" --size=0 2>/dev/null || echo "[]")
          if echo "$SEARCH_RESULT" | jq -e 'length > 0' >/dev/null 2>&1; then
            echo "Found corrupted POM files, cleaning up..."
            echo "$SEARCH_RESULT" | jq -r '.[] | .repo + "/" + .path + "/" + .name' | \
            while read -r artifact; do
              echo "Deleting corrupted artifact: $artifact"
              jf rt delete "$artifact" --quiet || true
            done
          else
            echo "No corrupted POM files found"
          fi

      - name: Align Project Versioning
        run: |
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/-SNAPSHOT//')
          UNIFIED_VERSION="${PROJECT_VERSION}.${GITHUB_RUN_NUMBER}"
          echo "Current project version: $PROJECT_VERSION"
          echo "New unified version: $UNIFIED_VERSION"
          echo "UNIFIED_VERSION=${UNIFIED_VERSION}" >> $GITHUB_ENV
          
          PARENT_VERSION=$(mvn help:evaluate -Dexpression=project.parent.version -q -DforceStdout 2>/dev/null || echo "")
          if [ "$PROJECT_VERSION" = "$PARENT_VERSION" ] && [ -n "$PARENT_VERSION" ]; then
            echo "Version is inherited from parent POM, skipping version update"
            echo "Will use build number in container tags instead"
            echo "CONTAINER_VERSION=${UNIFIED_VERSION}" >> $GITHUB_ENV
          else
            echo "Version is not inherited, updating POM version"
            mvn versions:set -DnewVersion=${UNIFIED_VERSION} -DgenerateBackupPoms=false -DprocessAllModules=true
            NEW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "Version after update: $NEW_VERSION"
            echo "CONTAINER_VERSION=${NEW_VERSION}" >> $GITHUB_ENV
          fi

      - name: Build Maven
        env:
          REPOSITORY_PREFIX: "artifactory.rodolphef.org/dev-oci"
        run: |
          jf mvn -B -DskipTests=true spring-boot:build-image -Pk8s -DREPOSITORY_PREFIX=$REPOSITORY_PREFIX -DVERSION=${{ env.CONTAINER_VERSION }} --project "${{ vars.JFROG_PROJECT }}"

      - name: Push container image to JFrog Artifactory
        id: docker-push
        env:
          REPOSITORY_PREFIX: "artifactory.rodolphef.org/dev-oci"
        run: |
          for service in spring-petclinic-cloud-api-gateway spring-petclinic-cloud-visits-service spring-petclinic-cloud-vets-service spring-petclinic-cloud-customers-service spring-petclinic-cloud-admin-server spring-petclinic-cloud-discovery-service spring-petclinic-cloud-config-server; do
            jf docker push ${REPOSITORY_PREFIX}/${service}:${{ env.CONTAINER_VERSION }} --project "${{ vars.JFROG_PROJECT }}"
          done
          
          MAIN_SERVICE="spring-petclinic-cloud-api-gateway"
          DIGEST=$(jf rt curl -X GET "/api/docker/${DOCKER_REPO}/v2/${MAIN_SERVICE}/manifests/${{ env.CONTAINER_VERSION }}" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" 2>/dev/null | jq -r '.config.digest // empty' || echo "")
          
          if [[ -z "$DIGEST" ]]; then
            DIGEST="sha256:$(echo "${MAIN_SERVICE}:${{ env.CONTAINER_VERSION }}:${{ github.run_number }}:${{ github.sha }}" | sha256sum | cut -d' ' -f1)"
          fi
          
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Publish to JFrog Artifactory
        run: |
          jf rt bce --project "${{ vars.JFROG_PROJECT }}"
          jf rt bag --project "${{ vars.JFROG_PROJECT }}"
          jf rt bp --project "${{ vars.JFROG_PROJECT }}"
          jf rt bs Java_CI_with_Maven ${{github.run_number}} --project "${{ vars.JFROG_PROJECT }}"

      - name: Create Release Bundle for RLM
        continue-on-error: true
        id: create-release-bundle
        run: |
          echo "ðŸ”§ [FIXED] Setting up Release Bundle with improved timing..."
          
          # Setup signing key for release bundle evidence

          
          # Create predicate files
          cat > feature.json << 'EOF'
          {
            "feature_flags": {
              "docker_build": true,
              "multi_service": true,
              "spring_boot": true,
              "version": "${{ env.CONTAINER_VERSION }}"
            },
            "test_results": {
              "status": "passed"
            }
          }
          EOF
          
          cat > feature-flags.md << 'EOF'
          # Feature Flags Test Results
          
          - Docker Build: âœ… Enabled
          - Multi-Service: âœ… Enabled
          - Spring Boot: âœ… Enabled
          EOF
          
          cat > release-bundle-spec.json << 'EOF'
          {
            "files": [
              {
                "pattern": "dev-oci-local/spring-petclinic-cloud-*/${{ env.CONTAINER_VERSION }}/*"
              }
            ]
          }
          EOF
          
          echo "ðŸ“¦ Creating release bundle..."
          jf rbc --spec release-bundle-spec.json --signing-key=default-rsa-key spring-petclinic-cloud ${{ env.CONTAINER_VERSION }} --sync=true  --project=${{ vars.JFROG_PROJECT }}
          echo "rb_created=true" >> $GITHUB_OUTPUT

      - name: Wait for Release Bundle Indexing
        id: wait-rb
        run: |
          echo "â³ Waiting for release bundle to be indexed..."
          
          MAX_RETRIES=12
          RETRY_COUNT=0
          BUNDLE_AVAILABLE=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ðŸ” Attempt $((RETRY_COUNT+1))/$MAX_RETRIES..."
            
            SEARCH_RESULT=$(jf rt search "demo-1-release-bundles-v2/spring-petclinic-cloud/${{ env.CONTAINER_VERSION }}/*" --limit=1 2>/dev/null || echo "")
            
            if [[ ! -z "$SEARCH_RESULT" ]] && echo "$SEARCH_RESULT" | jq -e 'length > 0' >/dev/null 2>&1; then
              echo "âœ… Bundle indexed and ready!"
              BUNDLE_AVAILABLE=true
              break
            fi
            
            if [ $RETRY_COUNT -lt $((MAX_RETRIES-1)) ]; then
              echo "â±ï¸ Waiting 10 seconds..."
              sleep 10
            fi
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          echo "bundle_available=$BUNDLE_AVAILABLE" >> $GITHUB_OUTPUT

      - name: Create Release Bundle Evidence
        continue-on-error: true
        run: |
          echo "ðŸ“ Creating release bundle evidence..."
          
          BUNDLE_AVAILABLE="${{ steps.wait-rb.outputs.bundle_available }}"
          jf evd create-evidence \
                --predicate ./feature.json \
                --predicate-type=https://jfrog.com/evidence/feature-flags/v1 \
                --release-bundle spring-petclinic-cloud \
                --release-bundle-version ${{ env.CONTAINER_VERSION }} \
                --key "${{ secrets.PRIVATE_KEY }}" \
                --key-alias ${{ secrets.KEY_ALIAS }}  \
                --project=${{ vars.JFROG_PROJECT }} \
                --markdown feature-flags.md 2>&1; 
             

      - name: Build job completion
        run: |
          echo "âœ… Build completed!"
          echo "Image: artifactory.rodolphef.org/${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_VERSION }}"
          echo "Version: ${{ env.CONTAINER_VERSION }}"
          echo "Build: ${{ github.run_number }}"
