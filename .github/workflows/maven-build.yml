name: Maven Build Pipeline

on:
  workflow_call:
    inputs:
      jfrog_project:
        required: true
        type: string

    secrets:
      JF_URL:
        required: true
      JF_ACCESS_TOKEN:
        required: true

permissions:
  contents: read
  id-token: write
  packages: write
  actions: read
  attestations: write

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.container_version }}
      image:   ${{ steps.metadata.outputs.image }}
      digest:  ${{ steps.metadata.outputs.digest }}

    env:
      REPO_PREFIX: artifactory.rodolphef.org/dev-oci
      JFROG_PROJECT: ${{ inputs.jfrog_project }}

    steps:

      #######################################################
      # CHECKOUT
      #######################################################
      - name: Checkout
        uses: actions/checkout@v4

      #######################################################
      # JAVA
      #######################################################
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: maven

      #######################################################
      # JFROG CLI
      #######################################################
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      #######################################################
      # EXTRACT VERSION
      #######################################################
      - name: Extract version
        id: version
        run: |
          RAW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          BASE_VERSION="${RAW_VERSION%-SNAPSHOT}"
          CONTAINER_VERSION="${BASE_VERSION}.${GITHUB_RUN_NUMBER}"

          echo "container_version=${CONTAINER_VERSION}" >> $GITHUB_OUTPUT
          echo "CONTAINER_VERSION=${CONTAINER_VERSION}" >> $GITHUB_ENV

      #######################################################
      # CONFIGURE MAVEN
      #######################################################
      - name: Configure Maven repos
        run: |
          jf mvnc \
            --repo-deploy-releases=${{ vars.MVN_DEV_REPO_DEPLOY_RELEASES }} \
            --repo-deploy-snapshots=${{ vars.MVN_DEV_REPO_DEPLOY_SNAPSHOTS }} \
            --repo-resolve-releases=${{ vars.MVN_DEV_REPO_RESOLVE_RELEASES }} \
            --repo-resolve-snapshots=${{ vars.MVN_DEV_REPO_RESOLVE_SNAPSHOTS }}

      #######################################################
      # BUILD IMAGES
      #######################################################
      - name: Build images
        run: |
          SERVICES=(
            "spring-petclinic-cloud-api-gateway"
            "spring-petclinic-cloud-visits-service"
            "spring-petclinic-cloud-vets-service"
            "spring-petclinic-cloud-customers-service"
            "spring-petclinic-cloud-admin-server"
            "spring-petclinic-cloud-discovery-service"
            "spring-petclinic-cloud-config-server"
          )

          for S in "${SERVICES[@]}"; do
            jf mvn -B -DskipTests spring-boot:build-image -Pk8s \
              -DREPOSITORY_PREFIX=${REPO_PREFIX} \
              -DVERSION=${CONTAINER_VERSION} \
              --project="${JFROG_PROJECT}"
          done

      #######################################################
      # PUSH IMAGES
      #######################################################
      - name: Push images
        run: |
          SERVICES=(
            "spring-petclinic-cloud-api-gateway"
            "spring-petclinic-cloud-visits-service"
            "spring-petclinic-cloud-vets-service"
            "spring-petclinic-cloud-customers-service"
            "spring-petclinic-cloud-admin-server"
            "spring-petclinic-cloud-discovery-service"
            "spring-petclinic-cloud-config-server"
          )

          for S in "${SERVICES[@]}"; do
            jf docker push ${REPO_PREFIX}/${S}:${CONTAINER_VERSION} \
              --project="${JFROG_PROJECT}"
          done

      #######################################################
      # EXTRACT DIGEST FOR API GATEWAY (MAIN IMAGE)
      #######################################################
      - name: Extract image metadata
        id: metadata
        run: |
          IMAGE="${REPO_PREFIX}/spring-petclinic-cloud-api-gateway:${CONTAINER_VERSION}"

          DIGEST=$(jf rt curl -X GET \
            "/api/docker/dev-oci-local/v2/spring-petclinic-cloud-api-gateway/manifests/${CONTAINER_VERSION}" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            | jq -r '.config.digest')

          echo "image=${IMAGE}"   >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      #######################################################
      # PUBLISH BUILD INFO
      #######################################################
      - name: Publish Build Info
        run: |
          jf rt bce --project="${JFROG_PROJECT}"
          jf rt bag --project="${JFROG_PROJECT}"
          jf rt bp  --project="${JFROG_PROJECT}"