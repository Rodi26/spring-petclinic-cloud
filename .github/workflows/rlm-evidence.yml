name: Generate RLM Evidence (matrix per microservice)

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      digest:
        required: true
        type: string
      container_version:
        required: true
        type: string
      jfrog_project:
        required: true
        type: string
    secrets:
      JF_URL:
        required: true
      JF_ACCESS_TOKEN:
        required: true
      PRIVATE_KEY:
        required: false
      KEY_ALIAS:
        required: false

permissions:
  contents: read
  id-token: write
  packages: write
  actions: read
  security-events: write
  attestations: write

jobs:
  rlm_evidence:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - spring-petclinic-cloud-api-gateway
          - spring-petclinic-cloud-visits-service
          - spring-petclinic-cloud-vets-service
          - spring-petclinic-cloud-customers-service
          - spring-petclinic-cloud-admin-server
          - spring-petclinic-cloud-discovery-service
          - spring-petclinic-cloud-config-server

    env:
      CONTAINER_VERSION: ${{ inputs.container_version }}
      JFROG_PROJECT: ${{ inputs.jfrog_project }}

    steps:
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Prepare SLSA provenance evidence payload
        run: |
          set -euo pipefail

          cat > slsa_provenance_evidence.json << 'EOF'
          {
            "slsa_provenance": {
              "version": "v1.0",
              "build_type": "https://github.com/slsa-framework/slsa-github-generator/container@v2.1.0",
              "builder": {
                "id": "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0"
              },
              "metadata": {
                "completeness": {
                  "parameters": true,
                  "environment": true,
                  "materials": true
                },
                "reproducible": false
              }
            }
          }
          EOF

          cat > slsa-provenance-results.md << EOF
          # SLSA Provenance Evidence

          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Build Number: ${{ github.run_number }}
          - Version: ${CONTAINER_VERSION}
          - Service: ${matrix.service}
          EOF

      - name: Prepare GitHub Actions evidence payload
        run: |
          set -euo pipefail

          cat > github_actions_evidence.json << EOF
          {
            "github_actions": {
              "workflow": {
                "name": "${{ github.workflow }}",
                "file": ".github/workflows/orchestrator.yml",
                "run_id": "${{ github.run_id }}",
                "run_number": "${{ github.run_number }}",
                "run_attempt": "${{ github.run_attempt }}",
                "job": "${{ github.job }}",
                "actor": "${{ github.actor }}",
                "triggering_actor": "${{ github.triggering_actor }}"
              },
              "repository": {
                "name": "${{ github.repository }}",
                "owner": "${{ github.repository_owner }}",
                "url": "${{ github.server_url }}/${{ github.repository }}",
                "default_branch": "${{ github.event.repository.default_branch }}",
                "private": ${{ github.event.repository.private }},
                "fork": ${{ github.event.repository.fork }}
              },
              "commit": {
                "sha": "${{ github.sha }}",
                "ref": "${{ github.ref }}",
                "ref_name": "${{ github.ref_name }}",
                "ref_type": "${{ github.ref_type }}"
              },
              "event": {
                "name": "${{ github.event_name }}"
              },
              "runner": {
                "os": "${{ runner.os }}",
                "arch": "${{ runner.arch }}"
              },
              "build_context": {
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "version": "${CONTAINER_VERSION}",
                "build_number": "${{ github.run_number }}",
                "environment": "github-actions"
              }
            }
          }
          EOF

          cat > github-actions-results.md << EOF
          # GitHub Actions Evidence

          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Run Number: ${{ github.run_number }}
          - Service: ${matrix.service}
          - Version: ${CONTAINER_VERSION}
          EOF

      - name: Prepare GitHub Attestation evidence payload
        run: |
          set -euo pipefail

          cat > github_attestation_evidence.json << EOF
          {
            "github_attestation": {
              "version": "v1",
              "attestation_type": "build-provenance",
              "subject": {
                "name": "${{ inputs.image }}",
                "digest": "${{ inputs.digest }}"
              },
              "predicate": {
                "builder": {
                  "id": "https://github.com/actions/runner",
                  "version": "${{ runner.os }}-${{ runner.arch }}"
                },
                "buildType": "https://github.com/actions/workflows/build",
                "metadata": {
                  "buildFinishedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                }
              }
            },
            "attestation_metadata": {
              "generated_by": "GitHub Actions",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "version": "${CONTAINER_VERSION}",
              "build_number": "${{ github.run_number }}"
            }
          }
          EOF

          cat > github-attestation-results.md << EOF
          # GitHub Attestation Evidence

          - Service: ${matrix.service}
          - Version: ${CONTAINER_VERSION}
          - Build Number: ${{ github.run_number }}
          EOF

      - name: Detect signing configuration
        id: signing
        run: |
          set -euo pipefail
          SIGNING_ARGS=""
          if [[ -n "${{ secrets.PRIVATE_KEY }}" && -n "${{ secrets.KEY_ALIAS }}" ]]; then
            echo "Signing enabled"
            echo "${{ secrets.PRIVATE_KEY }}" > evidence.key
            SIGNING_ARGS="--key evidence.key --key-alias '${{ secrets.KEY_ALIAS }}'"
          else
            echo "No signing key provided, publishing unsigned evidence"
          fi
          echo "SIGNING_ARGS=${SIGNING_ARGS}" >> $GITHUB_OUTPUT

      - name: Publish SLSA / GitHub / Attestation evidence for service
        env:
          SERVICE: ${{ matrix.service }}
          SIGNING_ARGS: ${{ steps.signing.outputs.SIGNING_ARGS }}
        run: |
          set -euo pipefail
          echo "Publishing evidence for ${SERVICE}:${CONTAINER_VERSION}"

          jf evd create-evidence \
            --predicate=slsa_provenance_evidence.json \
            --predicate-type=https://slsa.dev/provenance/v1 \
            --package-name "${SERVICE}" \
            --package-version "${CONTAINER_VERSION}" \
            --package-repo-name dev-oci-local \
            --markdown slsa-provenance-results.md \
            ${SIGNING_ARGS} \
            --project="${JFROG_PROJECT}" \
            || echo "⚠️ Failed to publish SLSA evidence for ${SERVICE}"

          jf evd create-evidence \
            --predicate=github_actions_evidence.json \
            --predicate-type=https://jfrog.com/evidence/github-actions/v1 \
            --package-name "${SERVICE}" \
            --package-version "${CONTAINER_VERSION}" \
            --package-repo-name dev-oci-local \
            --markdown github-actions-results.md \
            ${SIGNING_ARGS} \
            --project="${JFROG_PROJECT}" \
            || echo "⚠️ Failed to publish GitHub Actions evidence for ${SERVICE}"

          jf evd create-evidence \
            --predicate=github_attestation_evidence.json \
            --predicate-type=https://jfrog.com/evidence/github-attestation/v1 \
            --package-name "${SERVICE}" \
            --package-version "${CONTAINER_VERSION}" \
            --package-repo-name dev-oci-local \
            --markdown github-attestation-results.md \
            ${SIGNING_ARGS} \
            --project="${JFROG_PROJECT}" \
            || echo "⚠️ Failed to publish GitHub Attestation evidence for ${SERVICE}"

          echo "✅ Evidence publishing completed for ${SERVICE}"